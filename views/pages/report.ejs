<% layout('/layouts/boilerplate.ejs') -%>

<!-- Page Header -->
<section class="page-header">
    <h1>Report an Issue</h1>
    <p>Help your city improve â€” report problems, attach evidence, and track resolution in real time.</p>
</section>

<% if (typeof duplicate !== 'undefined' && duplicate) { %>
<div class="duplicate-warning" style="background: #fff3cd; border: 1px solid #ffc107; padding: 20px; margin: 20px; border-radius: 8px;">
    <h3 style="color: #856404; margin-top: 0;">âš ï¸ Potential Duplicate Detected</h3>
    <p><%= duplicate.message %></p>
    <p><strong>Similarity:</strong> <%= duplicate.similarity %>%</p>
    <% if (duplicate.matchingComplaint) { %>
    <div style="background: white; padding: 15px; border-radius: 5px; margin-top: 10px;">
        <p><strong>Similar Complaint:</strong></p>
        <p><strong>Category:</strong> <%= duplicate.matchingComplaint.category %></p>
        <p><strong>Description:</strong> <%= duplicate.matchingComplaint.description %></p>
        <p><strong>Location:</strong> <%= duplicate.matchingComplaint.location %></p>
        <a href="/complaints" class="btn btn-info" style="display: inline-block; padding: 8px 16px; background: #17a2b8; color: white; text-decoration: none; border-radius: 4px;">View Existing Complaint</a>
    </div>
    <% } %>
    <p style="margin-top: 15px;"><em>You can still submit this complaint if you believe it's different.</em></p>
</div>
<% } %>

<% if (typeof error !== 'undefined' && error) { %>
<div class="error-message" style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin: 20px; border-radius: 8px; color: #721c24;">
    <%= error %>
</div>
<% } %>

<form 
  action="/report" 
  method="POST" 
  enctype="multipart/form-data"
>

<div class="page">

  <div class="content">
    <div class="section-label">Select Issue Type</div>

    <!-- Hidden category input -->
    <input type="hidden" name="category" id="categoryInput" value="Water Leakage">

    <div class="issue-types">
      <div class="issue-card selected" data-type="Water Leakage">
        <div class="card-img">ğŸ’§</div>
        <div class="card-label">Water Leakage</div>
      </div>
      <div class="issue-card" data-type="Garbage">
        <div class="card-img">ğŸ—‘ï¸</div>
        <div class="card-label">Garbage Dump</div>
      </div>
      <div class="issue-card" data-type="Streetlight Issue">
        <div class="card-img">ğŸ’¡</div>
        <div class="card-label">Street Light Outage</div>
      </div>
      <div class="issue-card" data-type="Road Damage">
        <div class="card-img">ğŸ•³ï¸</div>
        <div class="card-label">Pothole</div>
      </div>
      <div class="issue-card" data-type="Drainage">
        <div class="card-img">ğŸš°</div>
        <div class="card-label">Drainage / Sewage</div>
      </div>
    </div>

    <script>
    // Update category when card is clicked
    document.querySelectorAll('.issue-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.issue-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        document.getElementById('categoryInput').value = card.dataset.type;
      });
    });
    </script>

    <div class="form-grid">

      <!-- Column 1: Image Upload -->
      <div class="form-card">
        <div class="card-header">
          <div class="card-icon g">ğŸ“·</div>
          <div>
            <div class="card-title">Upload Live Photo</div>
            <div class="card-sub">Attach a photo of the issue</div>
          </div>
        </div>

        <div class="upload-zone">
          <input 
            type="file" 
            id="photoInput" 
            name="image"
            accept="image/*" 
            capture="environment"
            required
          >
          <div class="uz-icon">ğŸ“</div>
          <div class="uz-text">
            Drag & drop or click to upload<br>
            <span style="color:#b0c0b2;font-size:0.67rem;">JPG, PNG, HEIC supported</span>
          </div>
          <button class="uz-btn" type="button">Browse Files</button>
        </div>

        <div class="preview-wrap" id="previewWrap">
          <img id="previewImg" src="" alt="preview">
          <button class="remove-img" id="removeImg" type="button">âœ•</button>
        </div>

        <div class="cam-row">
          <button class="cam-btn" type="button" onclick="openCamera()">ğŸ“¸ Take Live Photo</button>
        </div>
      </div>

      <!-- Column 2: Location -->
      <div class="form-card">
        <div class="card-header">
          <div class="card-icon b">ğŸ“</div>
          <div>
            <div class="card-title">Live GPS Location</div>
            <div class="card-sub">Auto-detected from your device</div>
          </div>
        </div>

        <div class="gps-box">
          <div class="gps-map">
            <div class="map-grid"></div>
            <div class="map-pin"></div>
          </div>
          <div class="gps-coords">
            <span>LAT</span><span id="latVal">Detectingâ€¦</span>
            &nbsp;&nbsp;
            <span>LNG</span><span id="lngVal">â€”</span>
          </div>
        </div>

        <button class="gps-refresh" type="button" onclick="getLocation()">
          <div class="gps-dot"></div> Refresh My Location
        </button>

        <label class="manual-label">Or enter manually</label>
        <input 
          class="manual-input" 
          type="text" 
          placeholder="Street address, landmark, areaâ€¦"
          name="location"
          required
        >
      </div>

      <!-- Column 3: Description -->
      <div class="form-card">
        <div class="card-header">
          <div class="card-icon o">âœï¸</div>
          <div>
            <div class="card-title">Describe the Issue</div>
            <div class="card-sub">Type or speak your complaint</div>
          </div>
        </div>

        <div class="desc-wrap">
          <textarea 
            id="description"
            name="description"
            placeholder="Describe the issue in detail â€” what happened, when, and how severeâ€¦"
            required
          ></textarea>

          <button 
            class="stt-btn" 
            id="sttBtn" 
            type="button"
            title="Tap to speak" 
            onclick="toggleSTT()"
          >ğŸ™ï¸</button>
        </div>

        <div class="stt-hint" id="sttHint">Tap ğŸ™ï¸ for voice input</div>

        <button type="submit" class="submit-btn">
          ğŸš¨ &nbsp;Submit Complaint
        </button>
      </div>

    </div>
  </div>
</div>

</form>

<!-- Toast (UI only) -->
<div class="toast" id="toast">âœ… Complaint submitted successfully!</div>

